<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Space-Weather Comms — Peter & Drones</title>
<style>
  :root{--bg:#0a0e1a;--card:#1a2540;--text:#e9f2ff;--accent:#ff6b6b;--border:rgba(255,107,107,.3);--ok:#9CFF6E;--warn:#FFD166}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:ui-rounded,system-ui,sans-serif;background:linear-gradient(180deg,#0a0e1a,#2a1a1a);color:var(--text);min-height:100vh;padding:20px}
  .container{max-width:1200px;margin:0 auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
  h1{font-size:2rem;color:var(--accent)}
  a.back{padding:10px 18px;border:2px solid var(--border);border-radius:12px;color:var(--accent);text-decoration:none;background:rgba(255,107,107,.15)}
  .section{margin-top:28px}
  .card{background:var(--card);border:2px solid var(--border);border-radius:18px;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
  canvas{width:100%;height:420px;display:block;border-radius:12px;background:#0d1630}
  .controls .row{margin-bottom:14px}
  label{display:block;font-weight:800;font-size:.95rem;color:var(--accent);margin-bottom:6px}
  input[type="range"],select{width:100%}
  .value{font-family:ui-monospace,Menlo,monospace;font-size:.9rem;opacity:.95}
  .btn{background:linear-gradient(180deg,#2e8cff,#1e6bd6);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.secondary{background:linear-gradient(180deg,#6fe6c2,#3abf9e);color:#00372b}
  .btnrow{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .note{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-top:10px}
  .dyk{margin-top:12px;background:rgba(255,255,255,.04);border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:12px}
  .dyk h3{font-size:.95rem;color:var(--accent);margin-bottom:6px}
  .quiz{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;align-items:center}
  .quiz button{background:rgba(255,107,107,.18);color:var(--accent);border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}
  .quiz .ok{color:#0f5132;background:rgba(111,230,194,.2);border-color:rgba(111,230,194,.5)}
  .quiz .no{color:#842029;background:rgba(255,107,107,.18);border-color:rgba(255,107,107,.5)}
  @media(max-width:900px){.grid{grid-template-columns:1fr}canvas{height:340px}}

  /* Lesson blocks */
  details.lesson{margin-top:14px;border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden}
  details.lesson>summary{cursor:pointer;list-style:none;padding:10px 14px;background:rgba(255,255,255,.05);font-weight:800;color:var(--accent)}
  details.lesson[open]>summary{border-bottom:1px solid rgba(255,255,255,.1)}
  .lesson-body{padding:12px 14px;display:grid;gap:10px}
  .lesson-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .tile{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .tile h4{margin-bottom:6px;color:#e9f2ff}
  .gt{margin-top:6px;padding:10px;border:1px dashed rgba(255,255,255,.18);border-radius:10px}
  .mc{display:grid;gap:6px;margin:6px 0}
  .mc label{display:flex;gap:8px;align-items:center;color:#e9f2ff;font-weight:600}
  .mc input{transform:translateY(1px)}
  .score{font-weight:800}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <a class="back" href="..">← Back</a>
    <h1>
      <a>~</a>
      / 
      <a href=".." > Space Weather Stories</a>
      /
      <a href="#">Peter’s Radio & Navigation Lab</a>
  </div>

  <!-- SIM 1: HF/VHF/UHF Radio Blackout (Pilot cockpit view) -->
  <div class="section card">
    <h2>Simulator 1 — HF/VHF/UHF link under flares (Peter’s cockpit)</h2>
    <p class="note">See HF fade under flare-driven D-layer absorption. VHF/UHF stay bright but are line-of-sight.</p>
    <div class="grid" style="margin-top:10px">
      <div>
        <canvas id="cockpitCanvas"></canvas>
        <div class="btnrow">
          <button id="pause1" class="btn secondary">Pause</button>
          <span class="value" id="readout1">Band: HF · Flare: M3 · Absorb: 35% · Status: readable</span>
        </div>
      </div>
      <div class="controls">
        <div class="row">
          <label for="band">Band</label>
          <select id="band">
            <option value="HF" selected>HF 3–30 MHz</option>
            <option value="VHF">VHF 30–300 MHz</option>
            <option value="UHF">UHF 300–3000 MHz</option>
          </select>
        </div>
        <div class="row">
          <label for="absorb">Ionospheric absorption</label>
          <input id="absorb" type="range" min="0" max="100" value="35"/>
        </div>
        <div class="row">
          <label for="flare">Flare class</label>
          <input id="flare" type="range" min="0" max="10" value="5"/>
          <div class="value" id="flareLabel">M3</div>
        </div>
        <div class="row">
          <label for="range">Range to HF station (nm)</label>
          <input id="range" type="range" min="100" max="3000" value="1200"/>
        </div>
      </div>
    </div>
    <div class="dyk">
      <h3>Did you know?</h3>
      <p>HF dies first in flares. VHF/UHF ignore the ionosphere but cannot cross oceans.</p>
      <div class="quiz" data-quiz="q1">
        <span class="value">Quick check:</span>
        <button data-correct="true">VHF is line-of-sight</button>
        <button data-correct="false">VHF rides the ionosphere</button>
        <span class="value" data-result></span>
      </div>
    </div>

    <!-- LESSON 1 -->
    <details class="lesson" open>
      <summary>Lesson: HF vs VHF vs UHF under solar flares</summary>
      <div class="lesson-body">
        <div class="lesson-grid">
          <div class="tile">
            <h4>Definition</h4>
            <p><b>HF</b>: 3–30&nbsp;MHz. Reflects from ionosphere for long-range.
            <br><b>VHF/UHF</b>: 30–300/300–3000&nbsp;MHz. Mostly straight-line paths.</p>
          </div>
          <div class="tile">
            <h4>Properties</h4>
            <ul>
              <li>Solar flares increase D-layer ionization → more <i>absorption</i> at HF.</li>
              <li>VHF/UHF less affected by ionosphere, limited by horizon and obstacles.</li>
              <li>Long-range HF needs lower absorption and suitable skip geometry.</li>
            </ul>
          </div>
          <div class="tile">
            <h4>Observations</h4>
            <ul>
              <li>Raising "Flare" and "Absorption" drives HF SNR down to blackout.</li>
              <li>VHF/UHF SNR tracks distance more than flare.</li>
              <li>Range slider shows skip vs LOS trade-offs.</li>
            </ul>
          </div>
        </div>
        <div class="gt">
          <div class="value">Guided test</div>
          <div class="mc" data-mc="l1">
            <label><input type="radio" name="l1q1" data-correct> HF suffers most during D-layer enhancement</label>
            <label><input type="radio" name="l1q1"> UHF reflects better when the Sun is active</label>
          </div>
          <div class="mc" data-mc="l1">
            <label><input type="radio" name="l1q2"> VHF crosses oceans by skywave in flares</label>
            <label><input type="radio" name="l1q2" data-correct> VHF/UHF remain LOS-limited</label>
          </div>
          <button class="btn" data-check="l1">Check</button>
          <span class="value score" data-score="l1"></span>
        </div>
      </div>
    </details>
  </div>

  <!-- SIM 2: GPS Scintillation & Position Error (Drone localization) -->
  <div class="section card">
    <h2>Simulator 2 — GPS scintillation vs drone position error</h2>
    <p class="note">Peter’s quadcopter needs clean GNSS. Scintillation and multipath inflate the error cloud.</p>
    <div class="grid" style="margin-top:10px">
      <div>
        <canvas id="gpsCanvas"></canvas>
        <div class="btnrow">
          <button id="pause2" class="btn secondary">Pause</button>
          <span class="value" id="readout2">S4: 0.45 · Elev: 25° · Multipath: medium · RMS: 4.2 m</span>
        </div>
      </div>
      <div class="controls">
        <div class="row">
          <label for="s4">Scintillation S4 (0–1)</label>
          <input id="s4" type="range" min="0" max="1" step="0.01" value="0.45"/>
        </div>
        <div class="row">
          <label for="elev">Satellite elevation (°)</label>
          <input id="elev" type="range" min="5" max="80" value="25"/>
        </div>
        <div class="row">
          <label for="multi">Multipath</label>
          <select id="multi">
            <option value="low">low</option>
            <option value="med" selected>medium</option>
            <option value="high">high</option>
          </select>
        </div>
      </div>
    </div>
    <div class="dyk">
      <h3>Did you know?</h3>
      <p>Low-elevation satellites add noise. The signal crosses more atmosphere and obstacles.</p>
      <div class="quiz" data-quiz="q2">
        <span class="value">Quick check:</span>
        <button data-correct="false">High elevation = worse</button>
        <button data-correct="true">Low elevation = worse</button>
        <span class="value" data-result></span>
      </div>
    </div>

    <!-- LESSON 2 -->
    <details class="lesson">
      <summary>Lesson: GNSS scintillation and positioning</summary>
      <div class="lesson-body">
        <div class="lesson-grid">
          <div class="tile">
            <h4>Definition</h4>
            <p><b>Scintillation</b> is rapid amplitude/phase fluctuation caused by small-scale ionospheric irregularities. <b>S4</b> quantifies amplitude scintillation (0–1).</p>
          </div>
          <div class="tile">
            <h4>Properties</h4>
            <ul>
              <li>Higher S4 → larger pseudorange error and cycle slips.</li>
              <li>Low satellite elevation increases path length and blockage risk.</li>
              <li>Multipath adds bias and variance to position estimates.</li>
            </ul>
          </div>
          <div class="tile">
            <h4>Observations</h4>
            <ul>
              <li>RMS error ring scales with S4 and multipath level.</li>
              <li>Raising elevation tightens links and shrinks the cloud.</li>
              <li>Scatter persistence visualizes time-correlated errors.</li>
            </ul>
          </div>
        </div>
        <div class="gt">
          <div class="value">Guided test</div>
          <div class="mc" data-mc="l2">
            <label><input type="radio" name="l2q1" data-correct> S4 closer to 1 implies stronger scintillation</label>
            <label><input type="radio" name="l2q1"> S4 near 1 means perfect signal</label>
          </div>
          <div class="mc" data-mc="l2">
            <label><input type="radio" name="l2q2"> Using only low-elevation satellites improves accuracy</label>
            <label><input type="radio" name="l2q2" data-correct> Higher elevation generally reduces error</label>
          </div>
          <button class="btn" data-check="l2">Check</button>
          <span class="value score" data-score="l2"></span>
        </div>
      </div>
    </details>
  </div>

  <!-- SIM 3: Drone C2 Link vs distance/interference (live swarm) -->
  <div class="section card">
    <h2>Simulator 3 — Drone command link vs distance & noise</h2>
    <p class="note">Peter’s drones adapt bitrate. Farther + noisier = packet loss and lag.</p>
    <div class="grid" style="margin-top:10px">
      <div>
        <canvas id="c2Canvas"></canvas>
        <div class="btnrow">
          <button id="pause3" class="btn secondary">Pause</button>
          <span class="value" id="readout3">Dist: 1.2 km · Noise: 35% · PL: 2% · RTT: 38 ms</span>
        </div>
      </div>
      <div class="controls">
        <div class="row">
          <label for="dist">Distance (km)</label>
          <input id="dist" type="range" min="0.1" max="5" step="0.1" value="1.2"/>
        </div>
        <div class="row">
          <label for="noise">Interference / noise</label>
          <input id="noise" type="range" min="0" max="100" value="35"/>
        </div>
        <div class="row">
          <label for="power">TX Power (dBm)</label>
          <input id="power" type="range" min="10" max="30" value="22"/>
        </div>
      </div>
    </div>
    <div class="dyk">
      <h3>Did you know?</h3>
      <p>Free-space loss rises with distance and frequency. Doubling distance costs ~6 dB.</p>
      <div class="quiz" data-quiz="q3">
        <span class="value">Quick check:</span>
        <button data-correct="true">2× distance ≈ +6 dB loss</button>
        <button data-correct="false">2× distance ≈ +1 dB loss</button>
        <span class="value" data-result></span>
      </div>
    </div>

    <!-- LESSON 3 -->
    <details class="lesson">
      <summary>Lesson: Link budget and performance</summary>
      <div class="lesson-body">
        <div class="lesson-grid">
          <div class="tile">
            <h4>Definition</h4>
            <p><b>Link budget</b> sums gains and losses from TX to RX to estimate SNR, packet loss, and latency.</p>
          </div>
          <div class="tile">
            <h4>Properties</h4>
            <ul>
              <li>Path loss ≈ 20·log10(f) + 20·log10(d) + const.</li>
              <li>Higher noise floor reduces SNR and raises packet loss.</li>
              <li>Adaptive rate trades throughput for robustness.</li>
            </ul>
          </div>
          <div class="tile">
            <h4>Observations</h4>
            <ul>
              <li>Increasing distance or noise increases PL and RTT in the sim.</li>
              <li>Raising TX power improves SNR but within limits.</li>
              <li>Visual jitter of drones correlates with PL.</li>
            </ul>
          </div>
        </div>
        <div class="gt">
          <div class="value">Guided test</div>
          <div class="mc" data-mc="l3">
            <label><input type="radio" name="l3q1" data-correct> Higher noise floor → lower SNR</label>
            <label><input type="radio" name="l3q1"> Higher noise floor → higher SNR</label>
          </div>
          <div class="mc" data-mc="l3">
            <label><input type="radio" name="l3q2"> Doubling distance usually halves loss</label>
            <label><input type="radio" name="l3q2" data-correct> Doubling distance adds ~6 dB loss</label>
          </div>
          <button class="btn" data-check="l3">Check</button>
          <span class="value score" data-score="l3"></span>
        </div>
      </div>
    </details>
  </div>

  <!-- SIM 4: Spectrum Waterfall (noise floor + flares + jammers) -->
  <div class="section card">
    <h2>Simulator 4 — Spectrum waterfall (Peter scans the band)</h2>
    <p class="note">Watch carriers, telemetry, and noise rise under flares. Find a clean channel.</p>
    <div class="grid" style="margin-top:10px">
      <div>
        <canvas id="waterfallCanvas"></canvas>
        <div class="btnrow">
          <button id="pause4" class="btn secondary">Pause</button>
          <span class="value" id="readout4">Noise floor: −92 dBm · Flares: mild · Clean window at 915.4 MHz</span>
        </div>
      </div>
      <div class="controls">
        <div class="row">
          <label for="nf">Noise floor (dBm)</label>
          <input id="nf" type="range" min="-110" max="-70" value="-92"/>
        </div>
        <div class="row">
          <label for="flareN">Flare boost</label>
          <input id="flareN" type="range" min="0" max="10" value="2"/>
        </div>
        <div class="row">
          <label for="jams">Jammers</label>
          <select id="jams">
            <option value="0">none</option>
            <option value="1" selected>light</option>
            <option value="2">heavy</option>
          </select>
        </div>
      </div>
    </div>
    <div class="dyk">
      <h3>Did you know?</h3>
      <p>A higher noise floor shrinks link margin. Fewer clean channels remain.</p>
      <div class="quiz" data-quiz="q4">
        <span class="value">Quick check:</span>
        <button data-correct="false">Higher noise → more margin</button>
        <button data-correct="true">Higher noise → less margin</button>
        <span class="value" data-result></span>
      </div>
    </div>

    <!-- LESSON 4 -->
    <details class="lesson">
      <summary>Lesson: Reading waterfalls and choosing channels</summary>
      <div class="lesson-body">
        <div class="lesson-grid">
          <div class="tile">
            <h4>Definition</h4>
            <p><b>Waterfall</b> is a time-vs-frequency heatmap where color encodes power. Bright bands are signals.</p>
          </div>
          <div class="tile">
            <h4>Properties</h4>
            <ul>
              <li>Noise floor sets the baseline. Anything above may be usable but reduces margin.</li>
              <li>Interferers can be narrowband (carriers) or wideband (jammers).</li>
              <li>Solar activity can lift the whole floor or create ripples.</li>
            </ul>
          </div>
          <div class="tile">
            <h4>Observations</h4>
            <ul>
              <li>Raising "Flare" subtly brightens the background in the sim.</li>
              <li>Setting jammers adds strong stripes. Avoid those frequencies.</li>
              <li>Seek darker windows for best SNR.</li>
            </ul>
          </div>
        </div>
        <div class="gt">
          <div class="value">Guided test</div>
          <div class="mc" data-mc="l4">
            <label><input type="radio" name="l4q1" data-correct> Darker region → lower interference</label>
            <label><input type="radio" name="l4q1"> Darker region → stronger carrier</label>
          </div>
          <div class="mc" data-mc="l4">
            <label><input type="radio" name="l4q2"> Choose the brightest stripe for data</label>
            <label><input type="radio" name="l4q2" data-correct> Choose a dark gap for data</label>
          </div>
          <button class="btn" data-check="l4">Check</button>
          <span class="value score" data-score="l4"></span>
        </div>
      </div>
    </details>
  </div>

  <!-- FINAL LESSON TEST -->
  <div class="section card">
    <h2>Lesson wrap‑up test</h2>
    <p class="note">Answer all questions. Then press Score.</p>
    <div class="gt" id="final">
      <div class="mc" data-final>
        <div class="value">1) During a strong solar flare, which band is most likely to blackout first?</div>
        <label><input type="radio" name="f1" data-correct> HF</label>
        <label><input type="radio" name="f1"> UHF</label>
      </div>
      <div class="mc" data-final>
        <div class="value">2) Higher S4 typically means:</div>
        <label><input type="radio" name="f2" data-correct> More GNSS positioning error</label>
        <label><input type="radio" name="f2"> Cleaner GNSS signals</label>
      </div>
      <div class="mc" data-final>
        <div class="value">3) Doubling drone distance mainly affects:</div>
        <label><input type="radio" name="f3" data-correct> Path loss increases ~6 dB</label>
        <label><input type="radio" name="f3"> Latency drops</label>
      </div>
      <div class="mc" data-final>
        <div class="value">4) In a spectrum waterfall, a dark gap suggests:</div>
        <label><input type="radio" name="f4" data-correct> A cleaner channel</label>
        <label><input type="radio" name="f4"> A strong interfering carrier</label>
      </div>
      <button class="btn" id="finalScoreBtn">Score</button>
      <span class="value score" id="finalScore"></span>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const DPR=()=>window.devicePixelRatio||1;
function fit(c,ctx){const w=c.clientWidth||800,h=c.clientHeight||420;c.width=Math.round(w*DPR());c.height=Math.round(h*DPR());ctx.setTransform(DPR(),0,0,DPR(),0,0);return{w,h}}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function db2lin(db){return Math.pow(10,db/10)}

/* ===== micro-quiz (inline buttons) ===== */
document.addEventListener('click',e=>{
  const btn=e.target.closest('.quiz button'); if(!btn) return;
  const box=btn.closest('.quiz'); const res=box.querySelector('[data-result]');
  const ok=btn.getAttribute('data-correct')==='true';
  res.textContent= ok?'Correct ✅':'Try again';
  res.className='value '+(ok?'ok':'no');
});

/* ===== lesson guided tests (radio groups) ===== */
function scoreGroup(group){
  const blocks=[...document.querySelectorAll('.mc[data-mc="'+group+'"]')];
  let correct=0,total=0;
  blocks.forEach(b=>{
    const radios=[...b.querySelectorAll('input[type="radio"]')];
    const chosen=radios.find(r=>r.checked);
    const ok=radios.find(r=>r.hasAttribute('data-correct'));
    total++;
    if(chosen && chosen===ok) correct++;
  });
  const out=document.querySelector('[data-score="'+group+'"]');
  if(out) out.textContent=`Score: ${correct}/${total}`;
}

document.addEventListener('click',e=>{
  const btn=e.target.closest('[data-check]'); if(!btn) return;
  const g=btn.getAttribute('data-check');
  scoreGroup(g);
});

/* ===== final test scoring ===== */
function scoreFinal(){
  const sections=[...document.querySelectorAll('#final .mc[data-final]')];
  let correct=0,total=sections.length;
  sections.forEach(sec=>{
    const radios=[...sec.querySelectorAll('input[type="radio"]')];
    const chosen=radios.find(r=>r.checked);
    const ok=radios.find(r=>r.hasAttribute('data-correct'));
    if(chosen && chosen===ok) correct++;
  });
  const out=document.getElementById('finalScore');
  out.textContent=`Total: ${correct}/${total} ${correct===total?'✅ Perfect':' '}`;
}

document.getElementById('finalScoreBtn').addEventListener('click',scoreFinal);

/* ===== SIM 1: Cockpit link ===== */
(function(){
  const c=document.getElementById('cockpitCanvas'), ctx=c.getContext('2d');
  const band=document.getElementById('band'), absorb=document.getElementById('absorb'), flare=document.getElementById('flare'), range=document.getElementById('range');
  const flareSteps=['None','A','B','C','M1','M3','M5','X1','X2','X5','X10'];
  const readout=document.getElementById('readout1'); const pause=document.getElementById('pause1');
  let t=0, run=true;

  function linkQuality(){
    const b=band.value, A=+absorb.value, F=+flare.value, R=+range.value;
    const flareDb = F<=4?F*0.5 : F<=6? (F-3)*2 : (F-5)*4+6; // faster rise into X
    let snr=30;
    if(b==='HF'){ snr -= A*0.4 + flareDb*1.2 + (R/1000)*2; }
    if(b==='VHF'){ snr -= A*0.05 + flareDb*0.2 + (R/1000)*1; }
    if(b==='UHF'){ snr -= A*0.03 + flareDb*0.1 + (R/1000)*1.2; }
    return clamp(snr,-5,35);
  }

  function draw(){
    const {w,h}=fit(c,ctx); ctx.clearRect(0,0,w,h);
    // panel
    const grd=ctx.createLinearGradient(0,0,0,h); grd.addColorStop(0,'#112445'); grd.addColorStop(1,'#081327');
    ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);

    // horizon scan
    ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1;
    for(let i=0;i<8;i++){ctx.beginPath();ctx.moveTo(0,h*(i+1)/9);ctx.lineTo(w,h*(i+1)/9);ctx.stroke();}

    // sweeping scope
    const cx=w*.15, cy=h*.55, r=Math.min(w,h)*.35;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.lineWidth=2; ctx.stroke();
    const sweep=t*0.03; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,sweep,sweep+0.8); ctx.closePath();
    ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fill();

    // signal bars right side
    const snr=linkQuality(); const q=clamp((snr+5)/40,0,1);
    const bars=14, baseX=w-140, baseY=h-40, bw=8, gap=5;
    for(let i=0;i<bars;i++){
      const lvl=(i+1)/bars; const on=lvl<q;
      const ht=10+lvl*90*(0.7+0.3*Math.sin(t*0.06+i*0.5));
      ctx.fillStyle = on ? (q>0.7?'#9CFF6E': q>0.4? '#FFD166' : '#ff6b6b') : 'rgba(255,255,255,.08)';
      ctx.fillRect(baseX+i*(bw+gap), baseY-ht, bw, ht);
    }

    // fluttering waveform top
    ctx.beginPath();
    for(let x=40;x<w-180;x+=6){
      const y=h*.18 + Math.sin(t*0.12 + x*0.03)*(20+20*(1-q)) + Math.sin(t*0.07 + x*0.015)*8*(1.2-q);
      x===40?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    const grad=ctx.createLinearGradient(40,0,w-180,0);
    grad.addColorStop(0, 'rgba(124,244,255,0.5)'); grad.addColorStop(.5, 'rgba(156,255,110,0.6)'); grad.addColorStop(1, 'rgba(255,120,120,0.5)');
    ctx.strokeStyle=grad; ctx.lineWidth=3; ctx.stroke();

    // labels
    const fLabel=flareSteps[+flare.value];
    readout.textContent=`Band: ${band.value} · Flare: ${fLabel} · Absorb: ${+absorb.value}% · Status: ${q>0.7?'strong':q>0.4?'usable':q>0.2?'poor':'blackout'}`;

    if(run){ t+=1; requestAnimationFrame(draw); }
  }

  [band,absorb,flare,range].forEach(el=>el.addEventListener('input',()=>{ document.getElementById('flareLabel').textContent=flareSteps[+flare.value]; if(!run) draw(); }));
  pause.onclick=()=>{run=!run; pause.textContent=run?'Pause':'Resume'; if(run) draw();};
  draw();
})();

/* ===== SIM 2: GPS Scintillation ===== */
(function(){
  const c=document.getElementById('gpsCanvas'), ctx=c.getContext('2d');
  const s4=document.getElementById('s4'), elev=document.getElementById('elev'), multi=document.getElementById('multi');
  const readout=document.getElementById('readout2'); const pause=document.getElementById('pause2');
  let t=0, run=true, points=[];

  function errModel(){
    const S=+s4.value, E=+elev.value, M=multi.value;
    const mp = M==='low'?1 : M==='med'?1.6 : 2.4;
    const elevFactor = 1 + (45 - Math.min(45,E))/30; // >1 when E<45
    const sigma = 0.6 + 6*S*elevFactor*mp; // meters
    return clamp(sigma,0.5,20);
  }

  function draw(){
    const {w,h}=fit(c,ctx); ctx.clearRect(0,0,w,h);
    // ground grid
    ctx.strokeStyle='rgba(255,255,255,.07)'; ctx.lineWidth=1;
    for(let x=0;x<=w;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
    for(let y=0;y<=h;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}

    // true position
    const tx=w*0.6, ty=h*0.6;
    ctx.fillStyle='#4eaaff'; ctx.beginPath(); ctx.arc(tx,ty,5,0,Math.PI*2); ctx.fill();

    // scatter updates
    const sigma=errModel();
    for(let i=0;i<8;i++){
      const a=Math.random()*Math.PI*2;
      const r = Math.abs( (Math.random()**0.6) * sigma * 8 );
      points.push({x:tx + Math.cos(a)*r, y:ty + Math.sin(a)*r, life: 120});
    }
    points=points.slice(-500);

    // draw scatter with fading
    for(const p of points){
      const alpha = clamp(p.life/120,0,1);
      ctx.fillStyle=`rgba(156,255,110,${0.12+0.35*alpha})`;
      ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
      p.life -= 2;
    }

    // error circle RMS
    ctx.strokeStyle='rgba(255,209,102,.8)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(tx,ty, sigma*10, 0, Math.PI*2); ctx.stroke();

    // satellites arcs
    for(let k=0;k<5;k++){
      const ang=t*0.01 + k*1.2;
      const ex = tx + Math.cos(ang)*180, ey = ty - 110 - 40*Math.sin(ang*1.3);
      ctx.fillStyle='rgba(255,255,255,.8)'; ctx.beginPath(); ctx.arc(ex,ey,3,0,Math.PI*2); ctx.fill();
      // link ray with fading by elevation
      ctx.strokeStyle=`rgba(124,244,255,${clamp(+elev.value/80,0.2,1)})`;
      ctx.beginPath(); ctx.moveTo(tx,ty); ctx.lineTo(ex,ey); ctx.stroke();
    }

    readout.textContent = `S4: ${(+s4.value).toFixed(2)} · Elev: ${+elev.value}° · Multipath: ${multi.value} · RMS: ${sigma.toFixed(1)} m`;

    if(run){ t+=1; requestAnimationFrame(draw); }
  }

  [s4,elev,multi].forEach(el=>el.addEventListener('input',()=>{ if(!run) draw(); }));
  pause.onclick=()=>{run=!run; pause.textContent=run?'Pause':'Resume'; if(run) draw();};
  draw();
})();

/* ===== SIM 3: Drone C2 Link ===== */
(function(){
  const c=document.getElementById('c2Canvas'), ctx=c.getContext('2d');
  const dist=document.getElementById('dist'), noise=document.getElementById('noise'), power=document.getElementById('power');
  const readout=document.getElementById('readout3'); const pause=document.getElementById('pause3');
  let t=0, run=true;
  let drones=[...Array(6)].map((_,i)=>({x:120+i*40, y:140+i*18, vx:1+Math.random()*0.7, vy:0.6*Math.sin(i), jitter:0}));

  function metrics(){
    const D=+dist.value, N=+noise.value, P=+power.value;
    const pathLoss = 32.4 + 20*Math.log10(915) + 20*Math.log10(Math.max(D,0.1)); // Friis ~915 MHz
    const rx = P - pathLoss; // dBm vs ref
    const nf = -95 + N*0.15; // higher N → higher floor
    const SNR = rx - nf;
    const pl = clamp( 30*Math.exp(-SNR/7), 0, 80); // %
    const rtt = clamp( 20 + 200/(1+Math.max(SNR, -10)) + pl*0.6, 15, 400); // ms
    return {SNR,pl,rtt,rx,nf};
  }

  function draw(){
    const {w,h}=fit(c,ctx); ctx.clearRect(0,0,w,h);
    // field
    const grd=ctx.createLinearGradient(0,h*0.3,0,h); grd.addColorStop(0,'#0d1f42'); grd.addColorStop(1,'#091221');
    ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);

    // base station left
    ctx.fillStyle='#ffffff'; ctx.fillRect(30,h-120,10,100);
    ctx.beginPath(); ctx.moveTo(35,h-140); ctx.lineTo(15,h-100); ctx.lineTo(55,h-100); ctx.closePath(); ctx.fill();
    // sector beams
    for(let k=0;k<3;k++){
      ctx.strokeStyle='rgba(124,244,255,.15)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(40,h-140, 80+k*60, -0.15, 0.35); ctx.stroke();
    }

    const {SNR,pl,rtt}=metrics();
    const q=clamp((SNR+5)/25,0,1);

    // drones
    drones.forEach((d,i)=>{
      d.x += d.vx*(0.6+q); d.y += 0.6*Math.sin(t*0.03+i);
      if(d.x>w-40) d.x=80; // wrap
      d.jitter = (pl/100)*8;
      const jx = (Math.random()-0.5)*d.jitter, jy=(Math.random()-0.5)*d.jitter;

      // link line
      ctx.strokeStyle = q>0.7?'rgba(156,255,110,.7)': q>0.4?'rgba(255,209,102,.7)':'rgba(255,107,107,.7)';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(40,h-140); ctx.lineTo(d.x,d.y); ctx.stroke();

      // drone body
      ctx.fillStyle='#dfe9ff'; ctx.beginPath(); ctx.arc(d.x+jx,d.y+jy,10,0,Math.PI*2); ctx.fill();
      // rotors
      ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.beginPath();
      ctx.moveTo(d.x-16+jx,d.y+jy); ctx.lineTo(d.x+16+jx,d.y+jy);
      ctx.moveTo(d.x+jx,d.y-16+jy); ctx.lineTo(d.x+jx,d.y+16+jy);
      ctx.stroke();
      // packet marker
      if(Math.random() > pl/100){
        ctx.fillStyle='rgba(124,244,255,.6)'; ctx.fillRect(d.x-2, d.y-22, 4, 8);
      }
    });

    // gauges
    const gx=w-220, gy=30;
    function gauge(y,label,val,color){
      ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(gx,y,200,18);
      ctx.fillStyle=color; ctx.fillRect(gx,y, clamp(val,0,1)*200,18);
      ctx.fillStyle='#fff'; ctx.font='12px ui-monospace'; ctx.fillText(label, gx, y-4);
    }
    gauge(gy+30,'Link quality', q, q>0.7? '#9CFF6E' : q>0.4? '#FFD166' : '#ff6b6b');
    gauge(gy+60,'Packet loss', (pl/100), '#ff6b6b');
    gauge(gy+90,'Latency (norm)', clamp((rtt-20)/380,0,1), '#FFD166');

    readout.textContent = `Dist: ${(+dist.value).toFixed(1)} km · Noise: ${+noise.value}% · PL: ${pl.toFixed(0)}% · RTT: ${Math.round(rtt)} ms`;

    if(run){ t+=1; requestAnimationFrame(draw); }
  }

  [dist,noise,power].forEach(el=>el.addEventListener('input',()=>{ if(!run) draw(); }));
  document.getElementById('pause3').onclick=()=>{run=!run; pause.textContent=run?'Pause':'Resume'; if(run) draw();};
  draw();
})();

/* ===== SIM 4: Spectrum Waterfall ===== */
(function(){
  const c=document.getElementById('waterfallCanvas'), ctx=c.getContext('2d');
  const nf=document.getElementById('nf'), flare=document.getElementById('flareN'), jams=document.getElementById('jams');
  const readout=document.getElementById('readout4'); const pause=document.getElementById('pause4');
  let t=0, run=true; const rows=220; let buf=[];

  function synthRow(){
    const W=c.width, N=Math.floor((c.clientWidth||800)/2); // coarse bins
    const base=+nf.value; const fb=+flare.value; const jm=+jams.value;
    const row=new Float32Array(N);
    for(let i=0;i<N;i++){
      const f=i/N; // 0..1 across band
      let p=base + (fb*1.2)*Math.sin(t*0.03 + f*8); // flare ripple
      // carriers
      const carriers=[0.15,0.32,0.5,0.74,0.88];
      carriers.forEach((fc,idx)=>{
        const d=Math.abs(f-fc);
        p += 20*Math.exp(-d*120) * (1+0.2*Math.sin(t*0.05+idx));
      });
      // jammers
      if(jm>0){
        const jamsF = jm===1?[0.41]:[0.23,0.61];
        jamsF.forEach((fj)=>{ const d=Math.abs(f-fj); p += (jm===1?18:27)*Math.exp(-d*90); });
      }
      // noise floor small randomness
      p += (Math.random()-0.5)*2;
      row[i]=p;
    }
    return row;
  }

  function draw(){
    const {w,h}=fit(c,ctx);
    // push row
    buf.unshift(synthRow()); if(buf.length>rows) buf.pop();

    // paint waterfall top-down
    const N=buf[0]?.length||200; const binW=w/N; const rowH=h/rows;
    for(let r=0;r<buf.length;r++){
      const row=buf[r];
      for(let i=0;i<N;i++){
        const db=row[i];
        const q=clamp((db - (+nf.value) + 40)/45, 0, 1); // map to 0..1
        // colormap: blue -> green -> yellow -> red
        const R=Math.floor(255*clamp(q*1.8-0.2,0,1));
        const G=Math.floor(255*clamp(q*1.5,0,1));
        const B=Math.floor(255*clamp(1.2-q*1.4,0,1));
        ctx.fillStyle=`rgb(${R},${G},${B})`;
        ctx.fillRect(i*binW, r*rowH, Math.ceil(binW)+1, Math.ceil(rowH)+1);
      }
    }

    // cursor line sweeps
    ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=1;
    const cx=( (t*2) % w ); ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();

    readout.textContent = `Noise floor: ${+nf.value} dBm · Flares: ${+flare.value} · Clean window at ~915.${(20+Math.floor((Math.sin(t*0.02)+1)*20)).toString().padStart(1,'0')} MHz`;

    if(run){ t+=1; requestAnimationFrame(draw); }
  }

  [nf,flare,jams].forEach(el=>el.addEventListener('input',()=>{ if(!run) draw(); }));
  pause.onclick=()=>{run=!run; pause.textContent=run?'Pause':'Resume'; if(run) draw();};
  draw();
})();
</script>
</body>
</html>
