<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Space Weather Events Calendar — NASA DONKI</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{
    --bg:#071225; --bg2:#0b1730; --card:#0f1e3a; --text:#e9f2ff; --muted:#a6b8e6;
    --pop1:#7cf4ff; --pop2:#9CFF6E; --pop3:#FFD166; --pop4:#B28DFF; --danger:#ff6b6b;
    --radius:20px; --shadow:0 12px 40px -18px rgba(0,0,0,.6);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f0f6ff; --bg2:#e6f0ff; --card:#ffffff; --text:#0a1224; --muted:#5a6c90;
      --pop1:#0077ff; --pop2:#10c085; --pop3:#ffb703; --pop4:#7b61ff; --danger:#e63b3b;
      --shadow:0 12px 34px -18px rgba(0,0,0,.2);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:ui-rounded,system-ui,Inter,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
    background: radial-gradient(1100px 800px at -10% -10%, color-mix(in oklab,var(--pop4) 10%, transparent), transparent),
                radial-gradient(900px 700px at 120% 0%, color-mix(in oklab,var(--pop1) 10%, transparent), transparent),
                linear-gradient(180deg,var(--bg),var(--bg2));
  }
  .wrap{max-width:1100px;margin:auto;padding:20px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 16px}
  .logo{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
        background:conic-gradient(from 200deg,var(--pop1),var(--pop2),var(--pop3),var(--pop4)); color:#001a28; font-weight:900; box-shadow:var(--shadow)}
  h1{font-size:1.4rem;margin:0}
  .panel{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:color-mix(in oklab,var(--card) 92%, transparent);
         border:1px solid color-mix(in oklab,var(--muted) 25%, transparent); border-radius:var(--radius); padding:12px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace; background:color-mix(in oklab,var(--card) 70%, transparent);
       border:1px solid color-mix(in oklab,var(--muted) 25%, transparent); border-radius:12px; padding:8px 10px}
  .btn{padding:10px 14px; border-radius:12px; border:1px solid color-mix(in oklab,var(--muted) 30%, transparent);
       background:linear-gradient(180deg,color-mix(in oklab,var(--card) 88%, transparent),color-mix(in oklab,var(--card) 70%, transparent));
       color:var(--text); font-weight:800; cursor:pointer}
  .btn:hover{outline:2px solid color-mix(in oklab,var(--pop1) 40%, transparent)}
  .sp{flex:1}
  .cal{margin-top:14px;background:color-mix(in oklab,var(--card) 94%, transparent); border:1px solid color-mix(in oklab,var(--muted) 25%, transparent);
       border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
  .cal-head{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #title{font-weight:900}
  .grid{margin-top:12px; display:grid; grid-template-columns:repeat(7,1fr); gap:10px}
  .dow,.day{padding:10px; border-radius:16px; background:color-mix(in oklab,var(--card) 80%, transparent);
            border:1px solid color-mix(in oklab,var(--muted) 16%, transparent)}
  .dow{font-size:.88rem;color:var(--muted); text-align:center; font-weight:800}
  .day{min-height:120px; position:relative; transition:all .15s ease}
  .day:hover{border-color:color-mix(in oklab,var(--pop1) 35%, transparent)}
  .num{font-weight:900; font-size:1.05rem; margin-bottom:6px; display:block}
  .badge{margin-top:6px;margin-right:4px;display:inline-block;font-size:.72rem;padding:5px 8px;border-radius:8px;border:2px solid transparent;cursor:pointer;font-weight:800}
  .b-FLR{background:color-mix(in oklab,var(--pop3) 26%, transparent); border-color:color-mix(in oklab,var(--pop3) 55%, transparent)}
  .b-CME{background:color-mix(in oklab,var(--pop4) 26%, transparent); border-color:color-mix(in oklab,var(--pop4) 55%, transparent)}
  .b-GST{background:color-mix(in oklab,var(--pop2) 26%, transparent); border-color:color-mix(in oklab,var(--pop2) 55%, transparent)}
  .b-RBE{background:color-mix(in oklab,var(--danger) 22%, transparent); border-color:color-mix(in oklab,var(--danger) 50%, transparent)}
  .b-SEP{background:color-mix(in oklab,var(--pop1) 26%, transparent); border-color:color-mix(in oklab,var(--pop1) 55%, transparent)}
  .b-HSS{background:color-mix(in oklab,var(--muted) 26%, transparent); border-color:color-mix(in oklab,var(--muted) 55%, transparent)}
  .b-NTF{background:color-mix(in oklab,var(--pop4) 20%, transparent); border-color:color-mix(in oklab,var(--pop4) 45%, transparent)}
  .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;padding:10px;background:color-mix(in oklab,var(--card) 72%, transparent);border-radius:12px}
  .leg{display:flex;gap:6px;align-items:center;font-size:.9rem}
  .dot{width:14px;height:14px;border-radius:4px;border:2px solid}
  .hint{color:var(--muted);font-size:.95rem;margin-top:8px}

  dialog{border:none;border-radius:20px;max-width:800px;width:95%;background:var(--card);color:var(--text);padding:0;box-shadow:0 40px 100px -30px rgba(0,0,0,.6)}
  .m-head{display:flex;gap:10px;align-items:center;padding:16px;border-bottom:1px solid color-mix(in oklab,var(--muted) 20%, transparent)}
  .m-body{padding:16px}
  .m-foot{display:flex;gap:10px;justify-content:flex-end;padding:16px;padding-top:0}
  pre.kbd{white-space:pre-wrap;max-height:60vh;overflow:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="..">← Back</a>
      <div class="logo" aria-hidden="true">☼</div>
    <h1>
      <!-- <a href = "https://dbxdrgsl.github.io">~</a> -->
      <a>~</a>
      / 
      <a href=".." > Space Weather Stories</a>
      /
      <a href="#">Space Weather Events Calendar</a>
    </h1>
  </div>
    </header>

    <div class="panel">
      <button class="btn" id="prev">◀</button>
      <div id="title">Month YYYY</div>
      <button class="btn" id="next">▶</button>
      <div class="sp"></div>
      <label>Year
        <select id="year" class="kbd" style="min-width:90px"></select>
      </label>
      <label>API key
        <input id="key" class="kbd" placeholder="api.nasa.gov key" style="min-width:180px"/>
      </label>
      <button class="btn" id="today">Today</button>
      <button class="btn" id="reload">Reload</button>
    </div>

    <section class="cal">
      <div class="cal-head">
        <div class="hint">Data source: NASA DONKI (Database Of Notifications, Knowledge, Information)</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="legend">
        <div style="font-weight:900;width:100%;color:var(--pop1)">Event Types</div>
        <div class="leg"><span class="dot b-FLR"></span> FLR — Solar Flare</div>
        <div class="leg"><span class="dot b-CME"></span> CME — Coronal Mass Ejection</div>
        <div class="leg"><span class="dot b-GST"></span> GST — Geomagnetic Storm</div>
        <div class="leg"><span class="dot b-RBE"></span> RBE — Radio Blackout</div>
        <div class="leg"><span class="dot b-SEP"></span> SEP — Solar Energetic Particles</div>
        <div class="leg"><span class="dot b-HSS"></span> HSS — High Speed Stream</div>
        <div class="leg"><span class="dot b-NTF"></span> NTF — Notification</div>
      </div>
      <p class="hint">Click a badge to view full details. Calendar refreshes itself periodically.</p>
    </section>
  </div>

  <dialog id="modal">
    <div class="m-head">
      <strong id="mTitle">Event</strong>
      <div class="sp"></div>
      <button class="btn" id="mClose">Close</button>
    </div>
    <div class="m-body" id="mBody"></div>
    <div class="m-foot">
      <button class="btn" id="copy">Copy JSON</button>
    </div>
  </dialog>

<script>
/* ---------- Controls & State ---------- */
const grid = document.getElementById('grid');
const titleEl = document.getElementById('title');
const yearSel = document.getElementById('year');
const keyInput = document.getElementById('key');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const reloadBtn = document.getElementById('reload');
const todayBtn = document.getElementById('today');

const modal = document.getElementById('modal');
const mTitle = document.getElementById('mTitle');
const mBody = document.getElementById('mBody');
document.getElementById('mClose').onclick = ()=>modal.close();
document.getElementById('copy').onclick = ()=>{
  const pre = mBody.querySelector('pre');
  if(pre) navigator.clipboard.writeText(pre.innerText);
};

const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
let current = new Date(); current.setDate(1);

const DEFAULT_KEY = 'o9FIZEgU2itrew0k9Y2qA9RhmeL49feU2B7fGZRR';
keyInput.value = localStorage.getItem('donki_key') || DEFAULT_KEY;
keyInput.addEventListener('change', ()=>localStorage.setItem('donki_key', keyInput.value.trim()));

const thisMonthKey = ()=> new Date().toISOString().slice(0,7);

/* ---------- Year selector ---------- */
(function fillYears(){
  const now = new Date().getFullYear();
  for(let y=now-5; y<=now+1; y++){
    const opt=document.createElement('option'); opt.value=y; opt.textContent=y;
    if(y===now) opt.selected = true;
    yearSel.appendChild(opt);
  }
})();
yearSel.addEventListener('change', ()=>{ current.setFullYear(+yearSel.value); renderCalendar(); });

/* ---------- Navigation ---------- */
prevBtn.onclick = ()=>{ current.setMonth(current.getMonth()-1); syncYear(); renderCalendar(); };
nextBtn.onclick = ()=>{ current.setMonth(current.getMonth()+1); syncYear(); renderCalendar(); };
reloadBtn.onclick = ()=> renderCalendar(true);
todayBtn.onclick = ()=>{ const t=new Date(); current = new Date(t.getFullYear(), t.getMonth(), 1); syncYear(); renderCalendar(); };

function syncYear(){ yearSel.value = String(current.getFullYear()); }

/* ---------- DONKI fetch ---------- */
async function fetchDONKI(start, end, key){
  const s = start.toISOString().slice(0,10);
  const e = end.toISOString().slice(0,10);
  const params = (u)=> u + (u.includes('?')?'&':'?') + new URLSearchParams({startDate:s,endDate:e,api_key:key}).toString();
  const urls = [
    'https://api.nasa.gov/DONKI/FLR',
    'https://api.nasa.gov/DONKI/CME',
    'https://api.nasa.gov/DONKI/WSAEnlilSimulations',
    'https://api.nasa.gov/DONKI/HSS',
    'https://api.nasa.gov/DONKI/GST',
    'https://api.nasa.gov/DONKI/RBE',
    'https://api.nasa.gov/DONKI/SEP',
    'https://api.nasa.gov/DONKI/notifications'
  ].map(params);

  const results = await Promise.allSettled(urls.map(u=>fetch(u).then(r=>r.ok?r.json():[])));
  const items = [];
  for(const r of results){ if(r.status==='fulfilled' && Array.isArray(r.value)) items.push(...r.value); }
  return items;
}

/* ---------- Helpers ---------- */
function groupByDate(items){
  const m = new Map();
  for(const it of items){
    const raw = it.eventDate || it.startTime || it.peakTime || it.beginTime || it.timeTag || it.startDate || it.publicationDate || it.messageIssueTime || it.activityID || '';
    const iso = String(raw).slice(0,10);
    if(!iso) continue;
    if(!m.has(iso)) m.set(iso, []);
    m.get(iso).push(it);
  }
  return m;
}
function typeOf(e){
  if(e.classType || e.flrID) return 'FLR';
  if(e.cmeAnalyses || e.cmeID) return 'CME';
  if(e.kpIndex || e.gstID) return 'GST';
  if(e.hssID) return 'HSS';
  if(e.radioID || e.rbeID) return 'RBE';
  if(e.sepID) return 'SEP';
  if(e.modelCompletionTime || e.modelInput || e.model) return 'WSA';
  if(e.messageType) return 'NTF';
  return 'NTF';
}
function labelOf(e){
  if(e.classType) return `FLR ${e.classType}`;
  if(e.kpIndex) return `Kp ${e.kpIndex}`;
  if(e.cmeAnalyses) return 'CME';
  if(e.hssID) return 'HSS';
  if(e.sepID) return 'SEP';
  if(e.messageType) return e.messageType.replace('Report','').trim();
  return 'Event';
}
function openEvent(e){
  if(e.__multi){
    mTitle.textContent = `${e.items.length} events`;
    mBody.innerHTML = `<pre class="kbd">${JSON.stringify(e.items,null,2)}</pre>`;
  }else{
    mTitle.textContent = labelOf(e);
    const kv = Object.entries(e).filter(([k])=>!k.startsWith('__'));
    mBody.innerHTML = `<div style="display:grid;gap:8px">${kv.map(([k,v])=>`
      <div><strong>${k}</strong>
        <div class="kbd" style="overflow:auto">${typeof v==='object'? `<pre style="margin:0">${JSON.stringify(v,null,2)}</pre>` : String(v)}</div>
      </div>`).join('')}
    </div>`;
  }
  modal.showModal();
}

/* ---------- Calendar Render ---------- */
async function renderCalendar(force=false){
  const mo = current.toLocaleString(undefined,{month:'long'});
  titleEl.textContent = `${mo} ${current.getFullYear()}`;

  // header row
  grid.innerHTML = DOW.map(d=>`<div class="dow">${d}</div>`).join('');

  const firstDayIndex = (current.getDay()+6)%7; // Monday=0
  const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1, 0).getDate();

  // leading blanks
  for(let i=0;i<firstDayIndex;i++) grid.insertAdjacentHTML('beforeend', `<div class="day" aria-hidden="true"></div>`);

  // fetch range (month + buffer week)
  const start = new Date(current.getFullYear(), current.getMonth(), 1);
  const end   = new Date(current.getFullYear(), current.getMonth()+1, 7);
  const key   = keyInput.value.trim() || DEFAULT_KEY;

  // cache key per month to reduce flicker when auto-refreshing
  const cacheKey = `donki_${start.toISOString().slice(0,7)}`;
  let items = [];
  if(!force){
    try{ items = JSON.parse(sessionStorage.getItem(cacheKey) || '[]'); }catch{}
  }
  if(force || items.length===0){
    items = await fetchDONKI(start,end,key);
    try{ sessionStorage.setItem(cacheKey, JSON.stringify(items)); }catch{}
  }

  const byDate = groupByDate(items);

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(current.getFullYear(), current.getMonth(), d);
    const iso = date.toISOString().slice(0,10);
    const evs = byDate.get(iso) || [];

    const cell = document.createElement('div');
    cell.className = 'day';
    cell.innerHTML = `<span class="num">${d}</span>`;

    if(evs.length){
      evs.slice(0,3).forEach(e=>{
        const b = document.createElement('button');
        b.className = `badge b-${typeOf(e)}`;
        b.textContent = labelOf(e);
        b.title = 'Open details';
        b.onclick = ()=> openEvent(e);
        cell.appendChild(b);
      });
      if(evs.length>3){
        const more = document.createElement('button');
        more.className='badge b-NTF';
        more.textContent = `+${evs.length-3} more`;
        more.onclick = ()=> openEvent({__multi:true, items:evs});
        cell.appendChild(more);
      }
    }
    grid.appendChild(cell);
  }
}

/* ---------- Auto refresh ---------- */
// Refresh every 5 minutes for the current month; less spam for others
setInterval(()=>{
  const nowKey = thisMonthKey();
  const viewKey = new Date(current).toISOString().slice(0,7);
  if(nowKey===viewKey) renderCalendar(true);
}, 5*60*1000);

/* ---------- Init ---------- */
(function init(){
  syncYear();
  renderCalendar();
})();
</script>
</body>
</html>
